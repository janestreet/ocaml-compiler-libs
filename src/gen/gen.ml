(* Note: this file is very similar to the one in Base for building the Caml
   library. However the Caml library should once this is merged:

   https://github.com/ocaml/ocaml/pull/1010

   It's going to be hard to do this for compiler-libs as it is a big breaking change. So
   we expect the gen.ml file in Base to go soon and this file to stay for longer.
*)

open StdLabels

let () =
  let ocaml_where, lib, oc =
    match Sys.argv with
    | [|_; "-ocaml-where"; ocaml_where; lib; "-o"; fn|] ->
      (ocaml_where, lib, open_out fn)
    | _ ->
      failwith "bad command line arguments"
  in

  let units =
    let (^/) = Filename.concat in
    try Read_cma.units (ocaml_where ^/ lib ^/ (lib ^ ".cma"))
    with Sys_error _ -> Read_cma.units (ocaml_where ^/ (lib ^ ".cma"))
  in

  let pr fmt = Printf.fprintf oc (fmt ^^ "\n") in
  pr "(* This file is automatically generated *)";
  pr "";
  let max_len =
    List.fold_left units ~init:0 ~f:(fun acc unit ->
      max acc (String.length unit))
  in
  List.iter units ~f:(fun u -> pr "module %-*s = %s" max_len u u);
